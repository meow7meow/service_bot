<script>
  // Функция для установки cookie
  function setCookie(name, value, days) {
    const d = new Date();
    d.setTime(d.getTime() + (days*24*60*60*1000));
    const expires = "expires=" + d.toUTCString();
    document.cookie = name + "=" + encodeURIComponent(value) + ";" + expires + ";path=/";
  }
  // Функция для чтения cookie по имени
  function getCookie(name) {
    const cname = name + "=";
    const decodedCookie = decodeURIComponent(document.cookie);
    const cookieArr = decodedCookie.split(';');
    for(let i = 0; i < cookieArr.length; i++) {
      let c = cookieArr[i].trim();
      if (c.indexOf(cname) === 0) {
        return c.substring(cname.length, c.length);
      }
    }
    return "";
  }
  // Функция для получения параметров из URL
  function getQueryParams() {
    const params = {};
    const urlParams = new URLSearchParams(window.location.search);
    for (const [key, value] of urlParams.entries()) {
      params[key] = decodeURIComponent(value);
    }
    return params;
  }

  // Сохраняем параметры в cookie (в виде JSON строки)
  function saveParamsToCookie(params) {
    setCookie("deviceParams", JSON.stringify(params), 7); // срок хранения 7 дней
  }
  // Получаем параметры из cookie
  function getParamsFromCookie() {
    const cookie = getCookie("deviceParams");
    if (cookie) {
      try {
        return JSON.parse(cookie);
      } catch (e) {
        return {};
      }
    }
    return {};
  }
  // Функция открытия Telegram
  function openTelegram(params) {
    const queryString = new URLSearchParams(params).toString();
    window.location.href = `tg://resolve?domain=biomusor7bot&${queryString}`;
  }

  // Основная функция инициализации
  function initPage() {
    let params = getQueryParams();

    if (Object.keys(params).length > 0) {
      // Есть параметры в URL — сохраняем в cookie
      saveParamsToCookie(params);
    } else {
      // Нет параметров в URL — пытаемся взять из cookie
      params = getParamsFromCookie();
    }

    if (Object.keys(params).length === 0) {
      document.getElementById('deviceData').innerHTML = 
        '<p style="color: red;">❌ Данные оборудования не переданы</p>';
      document.getElementById('telegramBtn').style.display = 'none';
      return;
    }

    const deviceHtml = Object.entries(params)
      .map(([key, value]) => `
        <div class="info-item">
          <strong>${key}:</strong> ${value}
        </div>
      `).join('');
    document.getElementById('deviceData').innerHTML = deviceHtml;
    document.getElementById('telegramBtn').onclick = function() {
      openTelegram(params);
    };
  }
  document.addEventListener('DOMContentLoaded', initPage);
</script>
